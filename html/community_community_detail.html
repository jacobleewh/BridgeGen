{% extends "base.html" %}

{% block title %}{{ community.name }} - BridgeGen{% endblock %}

{% block content %}
<div class="mb-4">
    <a href="/communities" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to Communities
    </a>
</div>

<!-- Community Header Card -->
<div class="card mb-4 border-0 shadow-sm overflow-hidden">
    <div style="height: 350px; position: relative;">
        {% if community.image_filename %}
            <img src="{{ url_for('uploaded_file', filename=community.image_filename) }}" 
                 alt="Cover Image" 
                 style="width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0;">
            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, rgba(0,0,0,0.2) 0%, rgba(0,0,0,0.8) 100%);"></div>
        {% else %}
            <div style="width: 100%; height: 100%; background: var(--gradient); position: absolute; top: 0; left: 0;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 8rem; color: white; opacity: 0.2;">
                    {% if community.category == 'tech' %}<i class="bi bi-laptop"></i>
                    {% elif community.category == 'arts' %}<i class="bi bi-palette"></i>
                    {% elif community.category == 'sports' %}<i class="bi bi-trophy"></i>
                    {% elif community.category == 'education' %}<i class="bi bi-book"></i>
                    {% elif community.category == 'social' %}<i class="bi bi-people"></i>
                    {% else %}<i class="bi bi-heart"></i>{% endif %}
                </div>
            </div>
        {% endif %}
        
        <div class="position-absolute bottom-0 start-0 p-4 p-md-5 text-white w-100">
            <div class="container">
                <div class="row align-items-end">
                    <div class="col-md-8">
                        <div class="d-flex gap-2 mb-3">
                            <span class="badge bg-light text-dark shadow-sm"><i class="bi bi-globe"></i> Public Group</span>
                            <span class="badge bg-white text-primary shadow-sm">
                                {{ community.category|title }}
                            </span>
                            {% if is_creator %}
                                <span class="badge bg-warning text-dark shadow-sm"><i class="bi bi-star-fill"></i> Admin</span>
                            {% endif %}
                        </div>
                        <h1 class="display-4 fw-bold mb-2" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">{{ community.name }}</h1>
                    </div>
                    <div class="col-md-4 text-md-end">
                        {% if not is_member %}
                            <a href="/communities/{{ community.id }}/join" class="btn btn-primary btn-lg fw-bold shadow-lg px-4 rounded-pill">
                                <i class="bi bi-plus-circle"></i> Join Community
                            </a>
                        {% else %}
                            <div class="dropdown">
                                <button class="btn btn-light btn-lg dropdown-toggle fw-bold shadow-lg px-4 rounded-pill" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-check-circle-fill text-success"></i> Member
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                                    {% if not is_creator %}
                                        <li><a class="dropdown-item text-danger" href="/communities/{{ community.id }}/leave" onclick="return confirm('Leave community?')">Leave Community</a></li>
                                    {% endif %}
                                </ul>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Navigation Tabs -->
<ul class="nav nav-pills mb-4 nav-fill bg-white p-2 rounded-pill shadow-sm" id="communityTab" role="tablist" style="font-size: 1.1rem;">
    <li class="nav-item" role="presentation">
        <button class="nav-link active fw-bold" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
            Overview
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link fw-bold" id="members-tab" data-bs-toggle="tab" data-bs-target="#members" type="button" role="tab">
            Members
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link fw-bold" id="activities-tab" data-bs-toggle="tab" data-bs-target="#activities" type="button" role="tab">
            Activities
        </button>
    </li>
    {% if is_creator %}
    <li class="nav-item" role="presentation">
        <button class="nav-link fw-bold" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
            Settings
        </button>
    </li>
    {% endif %}
</ul>

<!-- Tab Content -->
<div class="tab-content" id="communityTabContent">
    
    <!-- OVERVIEW TAB -->
    <div class="tab-pane fade show active" id="overview" role="tabpanel">
        
        <!-- Welcome / Motivation Section -->
        <div class="card border-0 bg-white shadow-sm mb-4">
            <div class="card-body p-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h3 class="fw-bold mb-3 text-primary"><i class="bi bi-sparkles"></i> Welcome to our Community!</h3>
                        <p class="lead mb-4">A place for meaningful connections across generations.</p>
                        <div class="row g-3">
                            <div class="col-sm-6">
                                <div class="d-flex gap-3">
                                    <div class="display-6 text-warning"><i class="bi bi-lightbulb"></i></div>
                                    <div>
                                        <h6 class="fw-bold">Share Wisdom</h6>
                                        <p class="small text-muted mb-0">Elders share life stories and traditional skills.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="d-flex gap-3">
                                    <div class="display-6 text-info"><i class="bi bi-phone"></i></div>
                                    <div>
                                        <h6 class="fw-bold">Digital Skills</h6>
                                        <p class="small text-muted mb-0">Youth help seniors master new technology.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-center border-start">
                        <div class="p-3">
                            <h5 class="fw-bold mb-3">Community Goals</h5>
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary rounded-pill btn-sm">
                                    <i class="bi bi-check-circle-fill"></i> Make New Friends
                                </button>
                                <button class="btn btn-outline-success rounded-pill btn-sm">
                                    <i class="bi bi-check-circle-fill"></i> Learn Something New
                                </button>
                                <button class="btn btn-outline-warning rounded-pill btn-sm">
                                    <i class="bi bi-check-circle-fill"></i> Stay Active
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Left Column: Feed -->
            <div class="col-md-8">
                <!-- Create Post -->
                {% if is_member %}
                <div class="card mb-4 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex gap-3">
                            <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center" style="width: 50px; height: 50px; font-size: 1.5rem;">
                                {{ current_user.username[0]|upper }}
                            </div>
                            <div class="w-100">
                                <form action="/communities/{{ community.id }}/posts/create" method="POST" enctype="multipart/form-data">
                                    <textarea name="content" class="form-control border-0 bg-light mb-2" rows="2" placeholder="What's on your mind, {{ current_user.username }}? Share with the community..." style="font-size: 1.1rem; resize: none;"></textarea>
                                    <div class="d-flex justify-content-between align-items-center border-top pt-2">
                                        <div class="input-group w-auto">
                                            <label class="btn btn-outline-primary btn-sm rounded-pill">
                                                <i class="bi bi-image"></i> Add Photo
                                                <input type="file" name="image" accept="image/*" hidden onchange="this.parentElement.classList.replace('btn-outline-primary', 'btn-primary');">
                                            </label>
                                        </div>
                                        <button type="submit" class="btn btn-primary px-4 rounded-pill fw-bold">Post</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Posts Feed -->
                {% for post in posts %}
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-white border-0 pt-3 pb-0">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="d-flex gap-2">
                                <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                    {{ post.author.username[0]|upper }}
                                </div>
                                <div>
                                    <h6 class="mb-0 fw-bold">{{ post.author.username }}</h6>
                                    <small class="text-muted">{{ post.created_at.strftime('%B %d at %I:%M %p') }}</small>
                                </div>
                            </div>
                            {% if post.author.id == current_user.id or is_creator %}
                            <div class="dropdown">
                                <button class="btn btn-link text-muted p-0" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item text-danger" href="#">Delete Post (Coming Soon)</a></li>
                                </ul>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body">
                        <p class="card-text mb-3" style="font-size: 1.1rem;">{{ post.content }}</p>
                        {% if post.image_filename %}
                            <img src="{{ url_for('static', filename='uploads/' + post.image_filename) }}" class="img-fluid rounded mb-3 w-100" alt="Post image">
                        {% endif %}
                    </div>
                    <div class="card-footer bg-white border-top-0 pt-0">
                        <div class="d-flex gap-2 mb-3 border-top border-bottom py-2">
                            <button class="btn btn-light flex-grow-1 {% if post.user_has_liked %}text-primary fw-bold{% endif %}" onclick="toggleLike({{ post.id }}, this)">
                                <i class="bi bi-hand-thumbs-up{% if post.user_has_liked %}-fill{% endif %}"></i> 
                                <span class="like-count">{{ post.like_count }}</span> Like
                            </button>
                            <button class="btn btn-light flex-grow-1" type="button" data-bs-toggle="collapse" data-bs-target="#comments-{{ post.id }}">
                                <i class="bi bi-chat"></i> Comment
                            </button>
                            <button class="btn btn-light flex-grow-1" onclick="copyLink('{{ request.host_url }}communities/{{ community.id }}#post-{{ post.id }}')">
                                <i class="bi bi-share"></i> Share
                            </button>
                        </div>
                        
                        <!-- Comments Section -->
                        <div class="collapse show" id="comments-{{ post.id }}">
                            {% for comment in post.comments %}
                            <div class="d-flex gap-2 mb-2">
                                <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center flex-shrink-0" style="width: 32px; height: 32px; font-size: 0.8rem;">
                                    {{ comment.author.username[0]|upper }}
                                </div>
                                <div class="bg-light p-2 rounded w-100">
                                    <div class="d-flex justify-content-between">
                                        <strong class="small">{{ comment.author.username }}</strong>
                                        <small class="text-muted" style="font-size: 0.75rem;">{{ comment.created_at.strftime('%b %d, %H:%M') }}</small>
                                    </div>
                                    <p class="mb-0 small">{{ comment.content }}</p>
                                </div>
                            </div>
                            {% endfor %}
                            
                            <form action="/posts/{{ post.id }}/comment" method="POST" class="d-flex gap-2 mt-2">
                                <input type="text" name="content" class="form-control form-control-sm rounded-pill bg-light" placeholder="Write a comment..." required>
                                <button type="submit" class="btn btn-primary btn-sm rounded-circle">
                                    <i class="bi bi-send"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-chat-square-text display-4 mb-3"></i>
                    <h4>No posts yet</h4>
                    <p>Be the first to start the conversation!</p>
                </div>
                {% endfor %}
            </div>
            
            <!-- Right Column: Info & Events -->
            <div class="col-md-4">
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-white fw-bold">
                        About This Community
                    </div>
                    <div class="card-body">
                        <p class="text-muted">{{ community.description }}</p>
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2"><i class="bi bi-calendar3 me-2 text-primary"></i> Created {{ community.created_at.strftime('%B %Y') }}</li>
                            <li class="mb-2"><i class="bi bi-people me-2 text-primary"></i> {{ community.member_count }} Members</li>
                        </ul>
                    </div>
                </div>

                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                        <span>Upcoming Events</span>
                        {% if is_creator %}
                            <a href="{{ url_for('community_create_event', community_id=community.id) }}" class="btn btn-sm btn-outline-primary rounded-pill">
                                <i class="bi bi-plus-lg"></i> Add
                            </a>
                        {% endif %}
                    </div>
                    <div class="card-body p-0">
                        {% if upcoming_events %}
                            <div class="list-group list-group-flush">
                                {% for event in upcoming_events[:3] %}
                                    <div class="list-group-item border-0 px-0 py-3">
                                        <div class="d-flex align-items-center">
                                            <div class="me-3 text-center bg-light rounded p-2" style="min-width: 60px;">
                                                <span class="d-block small text-uppercase text-primary fw-bold" style="font-size: 0.75rem;">{{ event.date_time.strftime('%b') }}</span>
                                                <span class="d-block h4 mb-0 fw-bold text-dark">{{ event.date_time.strftime('%d') }}</span>
                                            </div>
                                            <div class="flex-grow-1" style="min-width: 0;">
                                                <h6 class="mb-1 fw-bold text-dark text-truncate">{{ event.title }}</h6>
                                                <div class="d-flex align-items-center text-muted small mb-1">
                                                    <i class="bi bi-clock me-1"></i> {{ event.date_time.strftime('%I:%M %p') }}
                                                </div>
                                                <div class="text-muted small text-truncate">
                                                    <i class="bi bi-geo-alt me-1"></i> {{ event.location }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                                {% if upcoming_events|length > 3 %}
                                    <div class="card-footer text-center bg-white">
                                        <a href="#activities" onclick="document.getElementById('activities-tab').click()" class="text-decoration-none">See all events</a>
                                    </div>
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="p-4 text-center text-muted">
                                <i class="bi bi-calendar-x mb-2" style="font-size: 2rem;"></i>
                                <p class="mb-0">No upcoming events.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MEMBERS TAB -->
    <div class="tab-pane fade" id="members" role="tabpanel">
        <div class="card shadow-sm">
            <div class="card-body">
                <h4 class="card-title mb-4">Community Members</h4>
                <div class="row g-3">
                    {% for member in members %}
                    <div class="col-md-6 col-lg-4">
                        <div class="card h-100 border-light shadow-sm">
                            <div class="card-body d-flex align-items-center gap-3">
                                <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center flex-shrink-0" style="width: 60px; height: 60px; font-size: 1.5rem;">
                                    {{ member.username[0]|upper }}
                                </div>
                                <div class="flex-grow-1">
                                    <h5 class="mb-1">{{ member.username }}</h5>
                                    {% if member.role == 'admin' %}
                                        <span class="badge bg-warning text-dark mb-2">Admin</span>
                                    {% else %}
                                        <span class="badge bg-light text-dark border mb-2">Member</span>
                                    {% endif %}
                                    
                                    {% if member.id != current_user.id %}
                                        <div class="d-grid gap-2 d-flex">
                                            {% if member.is_friend_status %}
                                                <button class="btn btn-sm btn-outline-success disabled"><i class="bi bi-check"></i> Friends</button>
                                            {% else %}
                                                <button class="btn btn-sm btn-primary" onclick="addFriend({{ member.id }}, this)">
                                                    <i class="bi bi-person-plus"></i> Add Friend
                                                </button>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                    
                                    {% if is_creator and member.id != current_user.id %}
                                        <div class="mt-2">
                                            <small class="text-muted d-block mb-1">Manage Role:</small>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-secondary {% if member.role == 'member' %}active{% endif %}" onclick="setRole({{ community.id }}, {{ member.id }}, 'member')">Member</button>
                                                <button class="btn btn-outline-warning {% if member.role == 'admin' %}active{% endif %}" onclick="setRole({{ community.id }}, {{ member.id }}, 'admin')">Admin</button>
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- ACTIVITIES TAB -->
    <div class="tab-pane fade" id="activities" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3>Upcoming Activities</h3>
            {% if is_creator %}
                <a href="{{ url_for('community_create_event', community_id=community.id) }}" class="btn btn-primary">
                    <i class="bi bi-plus-lg"></i> Create New Event
                </a>
            {% endif %}
        </div>
        
        {% if upcoming_events %}
            <div class="row g-4">
                {% for event in upcoming_events %}
                <div class="col-md-6 col-lg-4">
                    <div class="card h-100 shadow-sm border-0">
                        <!-- Event Header with Gradient -->
                        <div class="position-relative" style="height: 150px; background: var(--gradient-pink); overflow: hidden; border-radius: var(--bs-card-border-radius) var(--bs-card-border-radius) 0 0;">
                            <div class="position-absolute top-50 start-50 translate-middle text-white" style="opacity: 0.3;">
                                <i class="bi bi-calendar-check" style="font-size: 5rem;"></i>
                            </div>
                            <div class="position-absolute top-0 end-0 m-3 bg-white text-primary rounded shadow-sm text-center p-2" style="min-width: 60px; line-height: 1.2;">
                                <span class="d-block small fw-bold text-uppercase">{{ event.date_time.strftime('%b') }}</span>
                                <span class="d-block fs-4 fw-bold">{{ event.date_time.strftime('%d') }}</span>
                            </div>
                        </div>
                        
                        <div class="card-body">
                            <h5 class="card-title fw-bold mb-3 text-dark">{{ event.title }}</h5>
                            
                            <div class="d-flex align-items-center text-muted mb-2">
                                <i class="bi bi-clock me-2 text-primary"></i>
                                <span>{{ event.date_time.strftime('%I:%M %p') }}</span>
                            </div>
                            <div class="d-flex align-items-center text-muted mb-3">
                                <i class="bi bi-geo-alt me-2 text-danger"></i>
                                <span class="text-truncate">{{ event.location }}</span>
                            </div>
                            
                            <p class="card-text text-muted small border-top pt-3">{{ event.description }}</p>
                        </div>
                        
                        <div class="card-footer bg-white border-top-0 pt-0 pb-3">
                            <button class="btn btn-outline-primary w-100 rounded-pill btn-sm">
                                <i class="bi bi-star"></i> Interested
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-5 bg-light rounded">
                <i class="bi bi-calendar-event display-1 text-muted"></i>
                <h4 class="mt-3 text-muted">No upcoming activities</h4>
                <p>Stay tuned for future events!</p>
            </div>
        {% endif %}
    </div>

    <!-- SETTINGS TAB (Admin Only) -->
    {% if is_creator %}
    <div class="tab-pane fade" id="settings" role="tabpanel">
        <div class="card shadow-sm border-0 mb-3">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-pencil-square"></i> Edit Community</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Update your community's name, description, category, and cover image.</p>
                <a href="/communities/{{ community.id }}/edit" class="btn btn-primary">
                    <i class="bi bi-pencil"></i> Edit Community Details
                </a>
            </div>
        </div>

        <div class="card shadow-sm border-0">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-trash"></i> Danger Zone</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-light border d-flex align-items-center" role="alert">
                    <i class="bi bi-info-circle text-primary fs-4 me-3"></i>
                    <div>
                        <strong>Archive or Delete</strong>
                        <p class="mb-0 text-muted small">Decide what happens to your community.</p>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center p-3 border rounded bg-light">
                    <div>
                        <h6 class="text-danger mb-1">Delete Community</h6>
                        <p class="text-muted small mb-0">Permanently remove this community and all its content.</p>
                    </div>
                    <form method="POST" action="/communities/{{ community.id }}/delete" onsubmit="return confirm('⚠️ Are you sure you want to delete this community?');">
                        <button type="submit" class="btn btn-outline-danger btn-sm">
                            <i class="bi bi-trash"></i> Delete Community
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

</div>

<script>
function toggleLike(postId, btn) {
    fetch(`/posts/${postId}/like`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const icon = btn.querySelector('i');
                const countSpan = btn.querySelector('.like-count');
                
                countSpan.textContent = data.count;
                
                if (data.action === 'liked') {
                    btn.classList.add('text-primary', 'fw-bold');
                    icon.classList.replace('bi-hand-thumbs-up', 'bi-hand-thumbs-up-fill');
                } else {
                    btn.classList.remove('text-primary', 'fw-bold');
                    icon.classList.replace('bi-hand-thumbs-up-fill', 'bi-hand-thumbs-up');
                }
            }
        });
}

function addFriend(userId, btn) {
    fetch(`/users/${userId}/add-friend`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success' || data.status === 'already_friends') {
                btn.className = 'btn btn-sm btn-outline-success disabled';
                btn.innerHTML = '<i class="bi bi-check"></i> Request Sent';
            }
        });
}

function setRole(communityId, userId, role) {
    fetch(`/communities/${communityId}/members/${userId}/role`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ role: role })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            location.reload();
        }
    });
}

function copyLink(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('Link copied to clipboard!');
    });
}
</script>
{% endblock %}