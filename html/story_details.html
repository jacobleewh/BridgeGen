{% extends "base.html" %}
{% block content %}

<div class="mb-3">
  <a href="javascript:history.back()" class="btn btn-outline-secondary">
    <i class="bi bi-arrow-left"></i> Back
  </a>
</div>

<!-- Story Details Container -->
<div class="big-card">
  <div class="big-card-header">
    <h4>{{ story.title }}</h4>
    <div class="text-muted small">
      By {{ story.author }} • Posted: {{ story.date }} • Tags: {{ ", ".join(story.tags) }}
    </div>
  </div>

  <div class="big-card-body">
    <!-- Text Section -->
    <h6>Written Story</h6>
    <p class="mb-4">{{ story.description }}</p>

    <!-- Media Section -->
    {% if story.media and story.media|length > 0 %}
      <h6>Media</h6>
      <div class="row mb-4">
        {% for m in story.media %}
          <div class="col-md-6 mb-3">
            {% if m.lower().endswith(('.jpg', '.jpeg', '.png', '.gif', '.webp', '.avif')) %}
              <img src="{{ url_for('static', filename=m.replace('static/', '')) }}" alt="Story media" class="story-media-img">
            {% elif m.lower().endswith(('.mp4', '.webm', '.avi', '.mov', '.mkv')) %}
              <video controls class="story-media-video">
                <source src="{{ url_for('static', filename=m.replace('static/', '')) }}" type="video/mp4">
                Your browser does not support the video tag.
              </video>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <!-- Audio Section below text -->
    {% if story.voice %}
      <h6>Listen to Story</h6>
      <audio controls>
        <source src="{{ story.voice }}" type="audio/webm">
        Your browser does not support the audio element.
      </audio>
    {% endif %}

    <!-- Interaction Buttons -->
    <div class="d-flex gap-2 mb-4 flex-wrap">
      <!-- Like, Save, Report buttons -->
      <button class="btn btn-outline-success" onclick="storyAction('like', {{ story.id }})">
        <i class="bi bi-hand-thumbs-up"></i> Like (<span id="like-count">{{ story.likes }}</span>)
      </button>
      <button class="btn btn-outline-secondary" id="save-btn" onclick="storyAction('save', {{ story.id }})">
        <i class="bi bi-bookmark"></i> <span id="save-text">{% if story.saved %}Saved{% else %}Save{% endif %}</span>
      </button>
      <button class="btn btn-outline-danger" onclick="storyAction('report', {{ story.id }})">
        <i class="bi bi-flag"></i> Report
      </button>
    </div>

    <!-- Comments Section -->
    <hr>
    <h5>Comments</h5>
    {% if story.comments %}
      <ul class="list-unstyled">
        {% for c in story.comments %}
          <li class="mb-3">
            <div><strong>{{ c.author }}</strong> <span class="text-muted small">said:</span></div>
            <div>{{ c.text }}</div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-muted">No comments yet. Be the first to share your thoughts!</p>
    {% endif %}

    <!-- Add Comment -->
    <form method="post" class="row g-2 mt-3">
      <input type="hidden" name="action" value="comment">
      <div class="col-md-3">
        <input class="form-control" name="author" placeholder="Your name" value="{{ current_user.username if current_user.is_authenticated else '' }}">
      </div>
      <div class="col-md-7">
        <input class="form-control" name="text" placeholder="Write a comment...">
      </div>
      <div class="col-md-2">
        <button class="btn btn-primary w-100" type="submit">Post</button>
      </div>
    </form>
  </div>
</div>

<link rel="stylesheet" href="{{ url_for('static', filename='story_style.css') }}">
<script src="{{ url_for('static', filename='js/story_script.js') }}"></script>

<script>
function storyAction(action, storyId) {
    const formData = new FormData();
    formData.append('action', action);
    
    fetch(window.location.href, {
        method: 'POST',
        body: formData
    })
    .then(response => response.text())
    .then(() => {
        if (action === 'like') {
            const likeCount = document.getElementById('like-count');
            likeCount.textContent = parseInt(likeCount.textContent) + 1;
        } else if (action === 'save') {
            const saveText = document.getElementById('save-text');
            const saveBtn = document.getElementById('save-btn');
            if (saveText.textContent === 'Save') {
                saveText.textContent = 'Saved';
                saveBtn.classList.add('active');
            } else {
                saveText.textContent = 'Save';
                saveBtn.classList.remove('active');
            }
        } else if (action === 'report') {
            alert('Story reported. Thank you for your feedback.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
    });
}
</script>

{% endblock %}
